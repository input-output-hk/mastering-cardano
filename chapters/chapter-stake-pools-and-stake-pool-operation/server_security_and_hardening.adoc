== Server Security and Hardening


``Security is a state of being that is characterized by a lack of fear or anxiety about one’s physical, economic, technological, or social well-being, or about the well-being of those for whom one is responsible. To reach this state in IT, it is necessary to take all preventative measures, put security policies and procedures into place, and carry out routine security assessments to find and address potential vulnerabilities. IT security is essential to achieving this state of affairs today with the widespread use of electronic communication by safeguarding computer systems, networks, and the data they store and transmit as well as by preventing data breaches.``

'''''

Here, we will acknowledge the security aspects involved with becoming a Stake Pool Operator (SPO). We will first look at the basic security principles of system administration in general, and then we will cover Cardano Node security, containerized environments, how to secure SSH, the benefits of using a VPN, and offer our final thoughts on Stake Pool security.

=== System Administration security

Below is a list of commonly used best practices in IT server administration for any project.

*NOTE*

==== All examples listed here are just suggestions of the commands you can use on Unix OS. Do not take anything for granted and please do your own research (DYOR) or read the command related manual (RTFM).

'''''

==== Best practice:

* Use a secure operating system with long-term support for your server to ensure that you have access to the latest security updates and patches.
* Always start with a clean minimal setup as OS hosting your Cardano environment.
* Ensure your day-to-day machine user account and cloud provider accounts have secure authentication methods, such as strong passwords and 2FA.
* Where possible, always set your server to use 2 public IPs. One for administration purposes (SSH and/or VPN) and one for the service you want to expose. This will minimize targeted attacks on your administration pipelines and leave only the services you chose to expose publicly (i.e. Webserver) as targets (this is commonly referred to as`minimising the attack surface area`).
* It is important to be cautious when doing system administration and make sure to always have a plan, document it and test it before applying it to the production environment besides having an automated reporting system (i.e. Prometheus/Grafana). Additionally, it is always recommended to have a recovery plan in case of any incident.
* Avoid running services as root when possible, as doing so increases the risk of unauthorized access or data breaches.
* Mind the exposed services, as they can be a target for cyber attacks. Be aware of the services that are running on your server, and take steps to secure them. It is reccomended to not leave any unused ports open on your server, as they can be used to gain unauthorized access to your system. Disable any unneeded open port/service or at least filter them using an adequate firewall rule. You have several options to list open ports with their associated service (some of these commands will also list services listening on 127.0.0.1 which is on the lo interface i.e. loopback): `sudo netstat -latupen` , `sudo lsof -i`, `sudo ss -antlp`.
* Implement Fail2Ban to block unauthorized access attempts or DOS attempts. This tool can help you to block/delay persistent and/or malicious IPs (port scanners/ crawlers, bruteforce techniques) from accessing your server.
* Change your server DNS to use known secure DNS (i.e. 1.1.1.1 and 1.0.0.1)
* Use a hardware/software firewall on your server and lock down the ports to only allow necessary traffic. Firewall rules can also mitigate DoS attacks and port flooding by using connlimit rules, see `iptables-extensions(8)` for examples. Use a firewall as a backup mechanism, after minding the open services. While a firewall can help to prevent further admin incidents, it can also increase the level of complexity and require additional specific attention.
* Keep your server’s operating system and installed software up-to-date with the latest updates to ensure that you have the latest security patches and fixes.
* Disable IPv6 on your server if you are not using it, as it can be used as a potential attack vector. Example command: `nano /etc/sysctl.conf` and add the line net.ipv6.conf.all.disable_ipv6 = 1
* Limit the programs with suid or sgid bit set, you may list them all with: `$ sudo find / -type f \( -perm -4000 -o -perm -2000 \) -exec ls -l {} \;`
* An additional step to ensure that you are protected from known vulnerabilities is to conduct a vulnerability scan using a tool such as nmap. While this may not be as precise or comprehensive as a commercial vulnerability scanner, it can still provide valuable insights.
* For those using systemd services, security may be checked with systemd-analyze security. It’s possible to harden every UNSAFE or EXPOSED service without messing with the distribution service file by adding an override.conf file in /etc/systemd/system/unit.service.d/ directory (unit being the name of any systemd service). Directives (like ProtectHome, ProtectSystem, ProtectHostname, etc.) are described in systemd.exec(5). The command line to do it is `systemctl edit unit.service`.
* A quick and easy way to monitor the overall health, load, and security of your system is by using a terminal multiplexer like `tmux`, along with the `tmuxp` session manager to save and reproduce tmux sessions from YAML or JSON files. This method is lightweight, efficient, and secure for remote access via SSH, and can be used as a text-based alternative or complement to Grafana. Some examples of commands that can be used in this setup are `dmesg, journalctl, iptables, tload, htop, systemctl, or any combination of watch, tail, and grep`.

=== Node Security:

* It is highly recommended to not operate both the `Block Producer` and a `Public Relay` on the same host, as the relay is exposed to the public and if it is compromised or under attack (DOS), your block producer will also be offline, resulting in missing the opportunity to produce blocks, which can negatively impact your ranking and associated rewards. To prevent this, it is best to secure the block producer behind a firewall and only allow it to connect to the relay nodes. The relay nodes can then connect to the block producer and other peer relays.
* It is recommended to only store the essential files (such as kes.skey, vrf.skey, etc.) on your server for running the cardano-node. It is also strongly recommended to keep other files related to your wallet/pool, such as private keys, on a separate, secure, and preferrably air-gapped device.
* Additionally, it is important to avoid running any programs, including `cardano-node` and `db-sync`, with root privileges. Instead, create a non-privileged account and use it for these tasks, and this applies to both non-containerized and containerized environments.
* It is always advisable to use a hardware wallet for your Pool as it will keep your private keys safe and secure.
* It is important to keep in mind that having a proper server security is crucial to ensure the availability, integrity, and confidentiality of your blockchain network. Having a proper segregation of different functionalities and roles in different servers and using unprivileged accounts can help to reduce the risk of unauthorized access or data breaches.

'''''

=== Containerized Enviroments

An other option is also the use containerized enviroments where the Cardano’s software can run logically separated from the hosting server, therefore containing possible breaches. As added layer of security the use of such software/enviroment it will increase also the level of IT knowledge to properly configure them.

Containerized Enviroments provides several advantages from a security point of view:

* Isolation: containers are isolated from one another and from the host system. This means that a security vulnerability or attack in one container will not affect other containers or the host system.
* Least Privilege: Each container runs with a specific set of permissions, reducing the risk of privilege escalation. This means that a malicious container will only have access to the resources it needs to function.
* Segmentation: allows for the creation of multiple isolated networks for different containers. This allows for better segmentation of different services and reduces the attack surface.
* Patching: allows for quick and easy patching of vulnerabilities in an application, without the need to patch the entire system.
* Auditing: provides detailed information about the container environment, including system calls, network connections, and file access. This information can be used to identify potential security issues and track down the source of a security incident.
* Security Scanning: provides security scanning feature and also severalthird party security scanning tools can be used to check images for vulnerabilities.
* Sandboxing: containers run in a Sandboxed environment, so that any malicious activity is restricted and the host system is not affected.
* Control over the environment: allows you to control the environment inwhich your application is running, and to ensure that it is running in a consistent and predictable environment.

It is important to keep in mind that while using containerized environments can greatly enhance security, it is not a complete solution. Adequate configuration and security measures must still be implemented within the containerized environment to guarantee the safety of your system.

A plethora of options exist that provide similar containerization functionality:

* LXC (LinuX Containers), Docker, rkt (Rocket), OpenVZ, LXD (built ontop of LXC), Kubernetes, Mesos.

Please note that while these alternatives provide similar functionality, they may have different architectural designs and may require different configurations and management processes. It is essential to evaluate the needs of your organization and compare each solution before making a decision.

'''''

==== Securing SSH

Given that SSH is frequently the primary method of remote server administration, we will highlight some key security considerations for securing SSH:

. Use a different port than the default 22/tcp, such as a port over 10000/tcp for added security. Example: `nano /etc/ssh/sshd_config` and change the line `Port 22` to `Port 10022`
. Disable access to root login on the SSH config and only use unprivileged account(s) with SUDO access. Example: `sudo nano /etc/ssh/sshd_config` and change the `PermitRootLogin to no`
. Use port knocking (`knockd`) to add an additional layer of security to your SSH connections.
. Disable (or fake) banners to prevent displaying unnecessary information that could potentially be used by attackers. Example: `nano /etc/ssh/sshd_config` and change the line `Banner /etc/issue.net` to `#Banner /etc/issue.net`
. Define a number of max concurrent sessions to limit the number of simultaneous connections to your server. Example: `nano /etc/ssh/sshd_config` and add the line `MaxSessions 10`
. Add it to your fail2ban instance to delay any attempt at brute-forcing or password guessing. Example: `nano /etc/fail2ban/jail.local` and add the section `[sshd] enabled = true`
. Disable password login in SSH. It is recommended not to use username/password authentication for SSH, instead use certificate-based (PKI) authentication for added security. Don’t forget to password protect your private key when you generate it. Example: `ssh-keygen -t rsa`
. When applicable, restrict access to the only IP address you’ll be using to connect to your server. Example: `nano /etc/ssh/sshd_config` and add the line `AllowUsers user@xxx.xxx.xxx.xxx`
. Use SFTP or SCP to transfer files (over SSH) to and from your server, as it provides an added layer of security compared to FTP.
. You can use SSH tunneling to encrypt redirect you traffic within your remote nodes, in order to access to your infra backend.

It is important to keep in mind that SSH is a fundamental service that allows remote access to a server, it is crucial to have it properly configured and secured to avoid any unauthorized access to your server.
It is also recommended to have a plan for monitoring and auditing SSH access (Grafana/fail2ban), as well as regular security updates and patches.

==== Use a VPN (as alternative to ssh tunneling)

Using a VPN (i.e. Wireguard) to access a server backend (Grafana/Prometheus/etc) is especially important for Stake Pool Operators (SPO) as it provides several benefits in terms of security and accessibility. A VPN (Virtual Private Network) creates a secure and encrypted connection between the client device and the server backend, protecting the data transmitted over the connection from potential eavesdropping or tampering.

This is particularly important when accessing sensitive information such as financial data, personal information, or confidential blockchain information. Additionally, a VPN allows remote access to the server backend, enabling SPOs to access the backend from anywhere in the world, as long as they have an internet connection. This can be especially useful for SPOs who are running their nodes remotely or in different locations.
Furthermore, using a VPN can also help to bypass any geographical restrictions or censorship. Overall, using a VPN to access a server backend is an effective way to secure and facilitate access to sensitive information and resources for SPOs.


'''''

=== Final Thoughts

Keep your setup simple and minimize your attack surface. Being overly cautious can increase the risk of having too much to monitor, or in some cases, cut yourself off from your system. Carefully manage your risks until you feel confident in your security, while having a contingency plan in place is always wise.

Your laptop, your air-gapped system, your relay node servers, and your block producer server will all have different levels of security based on their operational and economic value and the context in which they are being used (cloud, dedicated, or bare metal and geographical location). It’s important to have a security plan in place after considering different scenarios and making decisions accordingly.

Take the time to design the infrastructure you want to set up before you begin implementing it. This will save you time in the long run for maintenance and improvement.
