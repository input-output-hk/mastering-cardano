= Assigning Leadership Slots to Stake Pools
Andrew Westberg <andrewwestberg@gmail.com> 
:description: How does a pool get chosen to make a block?
:sectanchors: 
:url-repo: https://github.com/input-output-hk/mastering-cardano/chapters/chapter-stake-pools-and-stake-pool-operation
:imagesdir: illustrations

==== Overview
On proof-of-work blockchains like Bitcoin, miners create blocks by solving cryptographic puzzles, a very resource-intensive task. On Cardano, a proof-of-stake blockchain, stake pools are chosen to create a block based on a stake-weighted lottery system, described in the https://eprint.iacr.org/2016/889.pdf[Ouroboros paper], but we will give a simplified overview here.

==== Epochs, Blocks, and Slots
The leadership schedule on Cardano is broken up into epochs and  slots, with epochs being longer periods of time than slots. On Cardano mainnet, a new epoch starts every 5 days and begins at 21:44:51 UTC time. Each epoch contains 432,000 x one second slots (5 days). Other Cardano-based test networks or sidechains could of course have a different configuration, but we’ll discuss the Cardano mainnet here. 

In each slot , there is a possibility a block could be made. To maintain a secure system for creating blocks, it’s important for each stake pool node to determine if the pool is:

. Allowed to make a block in a given slot.
. Able to prove to other nodes that they were allowed to make a block.
. Able to hide from others that they are chosen to make a block in the future.

image::limbo.png[width=100%,title="Limbo"]
==== Playing Limbo
To simplify the explanation of how a pool is chosen to create a block, we will treat it as a game of Limbo. In order to win at Limbo, a person (the stake pool) needs to go under the bar (a threshold value). For every slot, the bar is uniquely set to a given height for each stake pool. The height is determined by how much stake is in the pool. Larger pools have a higher bar and thus it’s easier for them to win the game (make blocks). Smaller pools will have the bar set lower for them. The bar is not set to the exact same height every time, but rather randomly placed for every pool participating and then adjusted up or down based on the stake in the pool.

To determine whether or not the stake pool has made it under the bar in a given slot, several factors are assessed. 

First is the epoch nonce value. The epoch nonce is a long random number made up of a combination of the rolling nonce, which is updated every block, and also a block hash. The rolling nonce value is selected from the block right before the start of the stability window of the previous epoch.

Currently, the stability window is 1.5 days long, so the value from the block before that window is taken. Leadership information cannot be calculated until 1.5 days before the next epoch starts for the next epoch. The second value that goes into the epoch nonce is the hash of the last block of the previous epoch. Those values are concatenated and then hashed to give us the epoch nonce. The epoch nonce value is the same for all pools.

The epoch nonce is combined with the absolute slot number and the pool’s verifiable random functon (VRF) secret key to give a random output for any given slot. This value is then weighted based on how much stake is in the pool versus the total amount of ada that is delegated in the system. If this weighted random value is less than the threshold value, the pool is allowed to create a block. The pool has successfully won the game of Limbo for that slot!

==== Security
It’s important that only the pool operator knows when they will be making a block in the future. For this reason, the pool’s VRF secret key is used to check for leadership selection. The pool’s VRF public key is published on the blockchain. Because of this, it’s impossible for anyone other than the pool operator to know when they have a potential block-making opportunity. Other nodes can verify the VRF signature of the block using the pool’s public VRF key only after the fact to ensure the algorithm is fair and that the pool was allowed to make the block. Due to this secrecy, security is preserved, and it is untenable for an attacker to perform any type of DDoS attack against any particular stake pool.
